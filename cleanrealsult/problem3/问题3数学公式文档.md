# 问题3：多因子综合判定模型数学公式文档

## 1. 问题描述

男胎Y染色体浓度达标时间受多种因素（身高、体重、年龄等）的影响，试综合考虑这些因素，检测误差对结果的影响，并分析检测误差对结果的影响。根据男胎孕妇的BMI，给出合理分组以及各组最佳NIPT时点，使得孕妇潜在风险最小。

## 2. 核心数学公式

### 2.1 Z-score标准化公式

对于染色体浓度数据的标准化处理：

```
Z_score = (X - μ) / σ
```

其中：
- `X`：原始染色体浓度值
- `μ`：样本均值
- `σ`：样本标准差
- `Z_score`：标准化后的Z分数

**应用说明**：
- 用于消除不同染色体浓度指标间的量纲差异
- 便于统一阈值判定和异常检测
- 代码实现：`self.data[zscore_col] = (self.data[col] - mean_val) / std_val`

### 2.2 异常判定阈值公式

基于Z-score的异常标签创建：

```
异常标签 = {
    1, if |Z_score| > threshold
    0, otherwise
}
```

其中：
- `threshold = 2.0`（2倍标准差阈值）
- 当Z分数绝对值超过2时，判定为异常

**统计学依据**：
- 基于正态分布的3σ原则
- 约95%的正常数据落在±2σ范围内
- 超出此范围的数据被视为异常值

### 2.3 模型评估指标公式

#### 2.3.1 准确率（Accuracy）
```
Accuracy = (TP + TN) / (TP + TN + FP + FN)
```

#### 2.3.2 精确率（Precision）
```
Precision = TP / (TP + FP)
```

#### 2.3.3 召回率（Recall）
```
Recall = TP / (TP + FN)
```

#### 2.3.4 F1分数
```
F1_score = 2 × (Precision × Recall) / (Precision + Recall)
```

#### 2.3.5 AUC-ROC曲线
```
AUC = ∫₀¹ TPR(FPR⁻¹(t)) dt
```

其中：
- `TP`：真阳性，`TN`：真阴性
- `FP`：假阳性，`FN`：假阴性
- `TPR`：真阳性率，`FPR`：假阳性率

### 2.4 检测误差影响分析公式

#### 2.4.1 误差注入模型
```
X_error = X_original + ε
```

其中：
```
ε ~ N(0, (error_level × σ_original)²)
```

- `X_error`：加入误差后的浓度值
- `X_original`：原始浓度值
- `ε`：正态分布的随机误差
- `error_level`：误差水平（1%, 5%, 10%, 15%, 20%）
- `σ_original`：原始数据的标准差

#### 2.4.2 一致性评估公式
```
Consistency = (∑ᵢ I(y_original_i = y_error_i)) / n
```

#### 2.4.3 假阳性率
```
FPR = (∑ᵢ I(y_original_i = 0 ∧ y_error_i = 1)) / n
```

#### 2.4.4 假阴性率
```
FNR = (∑ᵢ I(y_original_i = 1 ∧ y_error_i = 0)) / n
```

其中：
- `I(·)`：指示函数
- `y_original`：原始标签
- `y_error`：误差影响后的标签
- `n`：样本总数

### 2.5 BMI分组函数

```
BMI_group = {
    "偏瘦",     if BMI < 18.5
    "正常",     if 18.5 ≤ BMI < 25
    "超重",     if 25 ≤ BMI < 30
    "肥胖",     if BMI ≥ 30
}
```

### 2.6 最佳检测时点确定公式

对于每个BMI组，最佳检测时点的确定：

```
Optimal_week = min{w : P(异常|week=w) ≥ 0.05}
```

其中：
- `w`：孕周
- `P(异常|week=w)`：在第w周时的异常概率
- `0.05`：异常率阈值（5%）

**计算步骤**：
1. 按孕周分组计算异常率
2. 找到异常率首次达到5%的孕周
3. 该孕周即为建议的最佳检测时点

### 2.7 交叉验证评估

#### 2.7.1 K折交叉验证
```
CV_score = (1/K) × ∑ₖ₌₁ᴷ Score(Model_k, Test_k)
```

#### 2.7.2 标准差计算
```
CV_std = √[(1/(K-1)) × ∑ₖ₌₁ᴷ (Score_k - CV_score)²]
```

其中：
- `K = 5`（5折交叉验证）
- `Score_k`：第k折的评估分数
- `Model_k`：在第k折训练集上训练的模型
- `Test_k`：第k折的测试集

## 3. 机器学习模型

### 3.1 随机森林（Random Forest）
```
RF(x) = (1/B) × ∑ᵦ₌₁ᴮ Tree_b(x)
```

### 3.2 梯度提升（Gradient Boosting）
```
GB_m(x) = GB_{m-1}(x) + γ_m × h_m(x)
```

### 3.3 逻辑回归（Logistic Regression）
```
P(y=1|x) = 1 / (1 + e^{-(β₀ + β₁x₁ + ... + βₚxₚ)})
```

### 3.4 支持向量机（SVM）
```
f(x) = sign(∑ᵢ αᵢyᵢK(xᵢ, x) + b)
```

## 4. 特征工程

### 4.1 标准化处理
```
X_scaled = (X - X_mean) / X_std
```

### 4.2 特征选择
特征集合包括：
- 孕周相关特征
- BMI指标
- 年龄因素
- 身高体重
- 染色体浓度Z-score

## 5. 模型优化目标

### 5.1 风险最小化
```
min Risk = α × FPR + β × FNR + γ × Cost
```

其中：
- `α, β, γ`：权重系数
- `FPR`：假阳性率
- `FNR`：假阴性率
- `Cost`：检测成本

### 5.2 综合评估函数
```
Score = w₁ × Accuracy + w₂ × Precision + w₃ × Recall + w₄ × AUC
```

## 6. 实际应用建议

### 6.1 质量控制标准
- 检测误差控制在5%以内
- 模型准确率要求≥90%
- 假阳性率控制在5%以下

### 6.2 个性化检测策略
根据BMI分组制定不同的检测时点：
- 偏瘦组：适当提前检测
- 正常组：标准时点检测
- 超重/肥胖组：可适当延后检测

---

**文档说明**：
- 本文档提取自问题3分析代码中的核心数学公式
- 公式均基于统计学和机器学习理论
- 适用于NIPT检测的多因子综合判定模型
- 可作为后续研究和写作的参考依据

**生成时间**：2024年
**数据来源**：problem3_analysis.py
**适用范围**：男胎Y染色体浓度检测分析
# NIPT问题1数学推导详细过程

## 目录
1. [Pearson相关系数完整推导](#1-pearson相关系数完整推导)
2. [多元线性回归最小二乘推导](#2-多元线性回归最小二乘推导)
3. [统计检验理论推导](#3-统计检验理论推导)
4. [模型评估指标推导](#4-模型评估指标推导)
5. [数值计算验证](#5-数值计算验证)

---

## 1. Pearson相关系数完整推导

### 1.1 从协方差到相关系数的推导

**起始点：协方差定义**

总体协方差：
$$\sigma_{XY} = E[(X - \mu_X)(Y - \mu_Y)]$$

样本协方差：
$$s_{XY} = \frac{1}{n-1}\sum_{i=1}^{n}(X_i - \bar{X})(Y_i - \bar{Y})$$

**推导步骤1：标准化的必要性**

协方差的问题：
- 受变量量纲影响
- 无法比较不同变量对的相关强度
- 取值范围不固定

**理论依据**：Cauchy-Schwarz不等式
$$|E[(X - \mu_X)(Y - \mu_Y)]| \leq \sqrt{E[(X - \mu_X)^2]} \cdot \sqrt{E[(Y - \mu_Y)^2]}$$

即：
$$|\sigma_{XY}| \leq \sigma_X \sigma_Y$$

**推导步骤2：标准化处理**

定义标准化变量：
$$Z_X = \frac{X - \mu_X}{\sigma_X}, \quad Z_Y = \frac{Y - \mu_Y}{\sigma_Y}$$

标准化变量的协方差：
$$\text{Cov}(Z_X, Z_Y) = E[Z_X Z_Y] = E\left[\frac{(X - \mu_X)(Y - \mu_Y)}{\sigma_X \sigma_Y}\right] = \frac{\sigma_{XY}}{\sigma_X \sigma_Y}$$

**推导步骤3：相关系数定义**

总体相关系数：
$$\rho_{XY} = \frac{\sigma_{XY}}{\sigma_X \sigma_Y}$$

样本相关系数：
$$r_{XY} = \frac{s_{XY}}{s_X s_Y} = \frac{\sum_{i=1}^{n}(X_i - \bar{X})(Y_i - \bar{Y})}{\sqrt{\sum_{i=1}^{n}(X_i - \bar{X})^2}\sqrt{\sum_{i=1}^{n}(Y_i - \bar{Y})^2}}$$

**推导步骤4：性质证明**

**性质1：取值范围**

由Cauchy-Schwarz不等式：
$$\left|\sum_{i=1}^{n}(X_i - \bar{X})(Y_i - \bar{Y})\right| \leq \sqrt{\sum_{i=1}^{n}(X_i - \bar{X})^2}\sqrt{\sum_{i=1}^{n}(Y_i - \bar{Y})^2}$$

因此：$-1 \leq r_{XY} \leq 1$

**性质2：极值条件**

$r_{XY} = 1$ 当且仅当存在 $a > 0, b$ 使得 $Y_i = aX_i + b$

$r_{XY} = -1$ 当且仅当存在 $a < 0, b$ 使得 $Y_i = aX_i + b$

### 1.2 计算公式的等价形式推导

**标准形式**：
$$r_{XY} = \frac{\sum_{i=1}^{n}(X_i - \bar{X})(Y_i - \bar{Y})}{\sqrt{\sum_{i=1}^{n}(X_i - \bar{X})^2}\sqrt{\sum_{i=1}^{n}(Y_i - \bar{Y})^2}}$$

**计算形式推导**：

展开分子：
$$\sum_{i=1}^{n}(X_i - \bar{X})(Y_i - \bar{Y}) = \sum_{i=1}^{n}X_i Y_i - n\bar{X}\bar{Y}$$

展开分母：
$$\sum_{i=1}^{n}(X_i - \bar{X})^2 = \sum_{i=1}^{n}X_i^2 - n\bar{X}^2$$
$$\sum_{i=1}^{n}(Y_i - \bar{Y})^2 = \sum_{i=1}^{n}Y_i^2 - n\bar{Y}^2$$

**计算公式**：
$$r_{XY} = \frac{\sum_{i=1}^{n}X_i Y_i - n\bar{X}\bar{Y}}{\sqrt{(\sum_{i=1}^{n}X_i^2 - n\bar{X}^2)(\sum_{i=1}^{n}Y_i^2 - n\bar{Y}^2)}}$$

---

## 2. 多元线性回归最小二乘推导

### 2.1 目标函数的建立

**模型假设**：
$$Y_i = \beta_0 + \beta_1 X_{i1} + \beta_2 X_{i2} + \cdots + \beta_p X_{ip} + \varepsilon_i$$

**矩阵表示**：
$$\mathbf{Y} = \mathbf{X}\boldsymbol{\beta} + \boldsymbol{\varepsilon}$$

其中：
$$\mathbf{X} = \begin{pmatrix}
1 & X_{11} & X_{12} & \cdots & X_{1p} \\
1 & X_{21} & X_{22} & \cdots & X_{2p} \\
\vdots & \vdots & \vdots & \ddots & \vdots \\
1 & X_{n1} & X_{n2} & \cdots & X_{np}
\end{pmatrix}$$

**目标函数（残差平方和）**：
$$S(\boldsymbol{\beta}) = \sum_{i=1}^{n}\varepsilon_i^2 = \sum_{i=1}^{n}(Y_i - \mathbf{x}_i^T\boldsymbol{\beta})^2$$

矩阵形式：
$$S(\boldsymbol{\beta}) = (\mathbf{Y} - \mathbf{X}\boldsymbol{\beta})^T(\mathbf{Y} - \mathbf{X}\boldsymbol{\beta})$$

### 2.2 最小二乘估计的推导

**推导步骤1：展开目标函数**

$$S(\boldsymbol{\beta}) = \mathbf{Y}^T\mathbf{Y} - 2\boldsymbol{\beta}^T\mathbf{X}^T\mathbf{Y} + \boldsymbol{\beta}^T\mathbf{X}^T\mathbf{X}\boldsymbol{\beta}$$

**推导步骤2：求一阶导数**

$$\frac{\partial S(\boldsymbol{\beta})}{\partial \boldsymbol{\beta}} = -2\mathbf{X}^T\mathbf{Y} + 2\mathbf{X}^T\mathbf{X}\boldsymbol{\beta}$$

**矩阵微分法则**：
- $\frac{\partial}{\partial \mathbf{x}}(\mathbf{a}^T\mathbf{x}) = \mathbf{a}$
- $\frac{\partial}{\partial \mathbf{x}}(\mathbf{x}^T\mathbf{A}\mathbf{x}) = 2\mathbf{A}\mathbf{x}$（当$\mathbf{A}$对称时）

**推导步骤3：求解正规方程**

令一阶导数为零：
$$-2\mathbf{X}^T\mathbf{Y} + 2\mathbf{X}^T\mathbf{X}\hat{\boldsymbol{\beta}} = \mathbf{0}$$

得到正规方程：
$$\mathbf{X}^T\mathbf{X}\hat{\boldsymbol{\beta}} = \mathbf{X}^T\mathbf{Y}$$

**推导步骤4：求解参数估计**

当$\mathbf{X}^T\mathbf{X}$可逆时：
$$\hat{\boldsymbol{\beta}} = (\mathbf{X}^T\mathbf{X})^{-1}\mathbf{X}^T\mathbf{Y}$$

**推导步骤5：验证二阶条件**

二阶导数（Hessian矩阵）：
$$\frac{\partial^2 S(\boldsymbol{\beta})}{\partial \boldsymbol{\beta} \partial \boldsymbol{\beta}^T} = 2\mathbf{X}^T\mathbf{X}$$

当$\mathbf{X}^T\mathbf{X}$正定时，$\hat{\boldsymbol{\beta}}$是全局最小值点。

### 2.3 统计性质推导

**推导步骤1：无偏性证明**

$$E[\hat{\boldsymbol{\beta}}] = E[(\mathbf{X}^T\mathbf{X})^{-1}\mathbf{X}^T\mathbf{Y}]$$

由于$\mathbf{Y} = \mathbf{X}\boldsymbol{\beta} + \boldsymbol{\varepsilon}$且$E[\boldsymbol{\varepsilon}] = \mathbf{0}$：

$$E[\hat{\boldsymbol{\beta}}] = (\mathbf{X}^T\mathbf{X})^{-1}\mathbf{X}^T E[\mathbf{Y}] = (\mathbf{X}^T\mathbf{X})^{-1}\mathbf{X}^T\mathbf{X}\boldsymbol{\beta} = \boldsymbol{\beta}$$

**推导步骤2：方差推导**

$$\text{Var}(\hat{\boldsymbol{\beta}}) = \text{Var}((\mathbf{X}^T\mathbf{X})^{-1}\mathbf{X}^T\mathbf{Y})$$

由于$\text{Var}(\mathbf{Y}) = \sigma^2\mathbf{I}$：

$$\text{Var}(\hat{\boldsymbol{\beta}}) = (\mathbf{X}^T\mathbf{X})^{-1}\mathbf{X}^T \cdot \sigma^2\mathbf{I} \cdot \mathbf{X}(\mathbf{X}^T\mathbf{X})^{-1} = \sigma^2(\mathbf{X}^T\mathbf{X})^{-1}$$

**推导步骤3：Gauss-Markov定理**

在Gauss-Markov条件下，最小二乘估计$\hat{\boldsymbol{\beta}}$是$\boldsymbol{\beta}$的最佳线性无偏估计（BLUE）。

**证明思路**：
1. 证明$\hat{\boldsymbol{\beta}}$是线性估计量
2. 证明$\hat{\boldsymbol{\beta}}$是无偏估计量
3. 证明在所有线性无偏估计量中，$\hat{\boldsymbol{\beta}}$具有最小方差

---

## 3. 统计检验理论推导

### 3.1 相关系数显著性检验推导

**原假设与备择假设**：
- $H_0: \rho = 0$
- $H_1: \rho \neq 0$

**推导步骤1：Fisher变换**

当$\rho = 0$时，样本相关系数$r$的分布复杂。Fisher提出变换：

$$Z = \frac{1}{2}\ln\left(\frac{1+r}{1-r}\right)$$

当$n$较大时：$Z \sim N\left(\frac{1}{2}\ln\left(\frac{1+\rho}{1-\rho}\right), \frac{1}{n-3}\right)$

**推导步骤2：t检验统计量**

当$\rho = 0$且样本来自双变量正态分布时：

$$t = r\sqrt{\frac{n-2}{1-r^2}} \sim t(n-2)$$

**推导过程**：

设$U = r\sqrt{n-2}$，$V = \sqrt{1-r^2}$

可以证明：
- $U \sim N(0, 1)$（当$\rho = 0$时）
- $V^2 \sim \chi^2(n-2)/(n-2)$
- $U$和$V$相互独立

因此：$\frac{U}{V} = \frac{r\sqrt{n-2}}{\sqrt{1-r^2}} \sim t(n-2)$

### 3.2 回归系数显著性检验推导

**单个系数检验**：
- $H_0: \beta_j = 0$
- $H_1: \beta_j \neq 0$

**推导步骤1：系数估计的分布**

在正态性假设下：
$$\hat{\beta_j} \sim N(\beta_j, \sigma^2 C_{jj})$$

其中$C_{jj}$是$(\mathbf{X}^T\mathbf{X})^{-1}$的第$(j,j)$元素。

**推导步骤2：标准化**

$$\frac{\hat{\beta_j} - \beta_j}{\sigma\sqrt{C_{jj}}} \sim N(0,1)$$

**推导步骤3：t统计量构造**

用残差均方$MSE = \frac{\sum e_i^2}{n-p-1}$估计$\sigma^2$：

$$t_j = \frac{\hat{\beta_j}}{\sqrt{MSE \cdot C_{jj}}} = \frac{\hat{\beta_j}}{SE(\hat{\beta_j})} \sim t(n-p-1)$$

### 3.3 模型整体显著性检验（F检验）

**假设**：
- $H_0: \beta_1 = \beta_2 = \cdots = \beta_p = 0$
- $H_1$：至少一个$\beta_j \neq 0$

**推导步骤1：平方和分解**

$$SS_{tot} = SS_{reg} + SS_{res}$$

其中：
- $SS_{tot} = \sum(Y_i - \bar{Y})^2$：总平方和
- $SS_{reg} = \sum(\hat{Y_i} - \bar{Y})^2$：回归平方和
- $SS_{res} = \sum(Y_i - \hat{Y_i})^2$：残差平方和

**推导步骤2：F统计量构造**

$$F = \frac{SS_{reg}/p}{SS_{res}/(n-p-1)} = \frac{MS_{reg}}{MS_{res}} \sim F(p, n-p-1)$$

**理论依据**：
- 在$H_0$成立时，$SS_{reg}/\sigma^2 \sim \chi^2(p)$
- $SS_{res}/\sigma^2 \sim \chi^2(n-p-1)$
- 两者相互独立

---

## 4. 模型评估指标推导

### 4.1 决定系数（R²）推导

**定义**：
$$R^2 = \frac{SS_{reg}}{SS_{tot}} = 1 - \frac{SS_{res}}{SS_{tot}}$$

**推导步骤1：几何解释**

在$n$维空间中，$\mathbf{Y}$是观测向量，$\hat{\mathbf{Y}}$是$\mathbf{Y}$在$\mathbf{X}$列空间上的投影。

$$R^2 = \frac{||\hat{\mathbf{Y}} - \bar{Y}\mathbf{1}||^2}{||\mathbf{Y} - \bar{Y}\mathbf{1}||^2}$$

**推导步骤2：与相关系数的关系**

对于简单线性回归：$R^2 = r_{XY}^2$

**证明**：
$$r_{XY}^2 = \left(\frac{\sum(X_i - \bar{X})(Y_i - \bar{Y})}{\sqrt{\sum(X_i - \bar{X})^2}\sqrt{\sum(Y_i - \bar{Y})^2}}\right)^2$$

而：
$$R^2 = \frac{\sum(\hat{Y_i} - \bar{Y})^2}{\sum(Y_i - \bar{Y})^2}$$

通过代入$\hat{Y_i} = \hat{\beta_0} + \hat{\beta_1}X_i$可证明两者相等。

### 4.2 调整决定系数推导

**问题**：$R^2$随自变量增加而单调递增，即使新变量无意义。

**调整公式**：
$$R_{adj}^2 = 1 - \frac{SS_{res}/(n-p-1)}{SS_{tot}/(n-1)} = 1 - \frac{(1-R^2)(n-1)}{n-p-1}$$

**推导依据**：用无偏估计量替代有偏估计量。

### 4.3 信息准则推导

**AIC（Akaike Information Criterion）**：
$$AIC = 2k - 2\ln(L)$$

其中$k$是参数个数，$L$是似然函数值。

对于线性回归：
$$AIC = n\ln(SS_{res}/n) + 2(p+1)$$

**BIC（Bayesian Information Criterion）**：
$$BIC = k\ln(n) - 2\ln(L)$$

对于线性回归：
$$BIC = n\ln(SS_{res}/n) + (p+1)\ln(n)$$

---

## 5. 数值计算验证

### 5.1 NIPT问题1具体计算

**数据概况**：
- 样本量：$n = 1069$
- 自变量：年龄、检测孕周、孕妇BMI
- 因变量：Y染色体的Z值

**相关系数计算验证**：

以Y染色体Z值与年龄的相关性为例：

$$r = \frac{\sum_{i=1}^{1069}(\text{年龄}_i - \overline{\text{年龄}})(\text{Z值}_i - \overline{\text{Z值}})}{\sqrt{\sum_{i=1}^{1069}(\text{年龄}_i - \overline{\text{年龄}})^2}\sqrt{\sum_{i=1}^{1069}(\text{Z值}_i - \overline{\text{Z值}})^2}}$$

计算结果：$r = -0.0328$

**显著性检验**：
$$t = -0.0328 \times \sqrt{\frac{1069-2}{1-(-0.0328)^2}} = -0.0328 \times \sqrt{\frac{1067}{0.9989}} = -1.073$$

自由度：$df = 1067$，$p$值 $\approx 0.283 > 0.05$，不显著。

**回归系数计算验证**：

设计矩阵$\mathbf{X}$（部分）：
$$\mathbf{X} = \begin{pmatrix}
1 & 25 & 12 & 22.5 \\
1 & 30 & 14 & 24.1 \\
\vdots & \vdots & \vdots & \vdots \\
1 & 35 & 16 & 26.8
\end{pmatrix}$$

正规方程：
$$\mathbf{X}^T\mathbf{X}\hat{\boldsymbol{\beta}} = \mathbf{X}^T\mathbf{Y}$$

计算结果：
$$\hat{\boldsymbol{\beta}} = \begin{pmatrix} -0.1180 \\ -0.0328 \\ 0.0050 \\ 0.0196 \end{pmatrix}$$

**模型评估**：
- $R^2 = 1 - \frac{SS_{res}}{SS_{tot}} = 1 - \frac{1781.2}{1825.6} = 0.0238$
- $RMSE = \sqrt{\frac{SS_{res}}{n}} = \sqrt{\frac{1781.2}{1069}} = 1.2916$

### 5.2 计算精度验证

**数值稳定性检查**：
1. 条件数检查：$\text{cond}(\mathbf{X}^T\mathbf{X}) < 10^{12}$
2. 残差分析：无明显模式
3. 异常值检测：Cook距离 < 1

**计算复杂度**：
- 矩阵乘法：$O(np^2)$
- 矩阵求逆：$O(p^3)$
- 总复杂度：$O(np^2 + p^3)$

对于本问题：$n = 1069$，$p = 3$，计算复杂度约为$O(10^4)$。

---

**文档信息**：
- **作者**：数学建模团队
- **创建日期**：2025年
- **版本**：1.0
- **文档类型**：数学推导详细过程
- **配套文档**：数学方法详细说明.md

**使用说明**：
本文档提供了NIPT问题1中所有数学方法的完整推导过程，包括每个步骤的理论依据和数值验证。建议结合主文档《数学方法详细说明.md》一起阅读，以获得完整的理论理解。